"""
Streamlit Dashboard for Social Media Marketing Agent
=====================================================
Web interface for viewing and editing post drafts generated by Gemini.
Allows manual editing of Georgian text before publishing.
"""

import streamlit as st
import os
from database import Database
from text_generator import TextGenerator
from PIL import Image


# Page configuration
st.set_page_config(
    page_title="ğŸ¯ áƒ¡áƒáƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒ”áƒ“áƒ˜áƒ˜áƒ¡ áƒ›áƒáƒ áƒ™áƒ”áƒ¢áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ“áƒáƒ¨áƒ‘áƒáƒ áƒ“áƒ˜",
    page_icon="ğŸ¯",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for Georgian text
st.markdown("""
<style>
    .main-header {
        font-size: 2.5rem;
        font-weight: bold;
        color: #FF9800;
        text-align: center;
        margin-bottom: 2rem;
    }
    .draft-card {
        background-color: #f5f5f5;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1rem;
    }
    .stTextArea textarea {
        font-size: 1.1rem;
        line-height: 1.6;
    }
</style>
""", unsafe_allow_html=True)


def initialize_session_state():
    """Initialize Streamlit session state."""
    if 'db' not in st.session_state:
        st.session_state.db = Database()

    if 'text_gen' not in st.session_state:
        api_key = os.getenv("GOOGLE_GEMINI_API_KEY")
        if api_key:
            st.session_state.text_gen = TextGenerator(api_key)
        else:
            st.session_state.text_gen = None


def main():
    """Main dashboard application."""
    initialize_session_state()

    db = st.session_state.db

    # Header
    st.markdown('<div class="main-header">ğŸ¯ áƒ¡áƒáƒªáƒ˜áƒáƒšáƒ£áƒ áƒ˜ áƒ›áƒ”áƒ“áƒ˜áƒ˜áƒ¡ áƒ›áƒáƒ áƒ™áƒ”áƒ¢áƒ˜áƒœáƒ’áƒ˜áƒ¡ áƒ“áƒáƒ¨áƒ‘áƒáƒ áƒ“áƒ˜</div>', unsafe_allow_html=True)

    # Sidebar
    with st.sidebar:
        st.header("ğŸ“‹ áƒœáƒáƒ•áƒ˜áƒ’áƒáƒªáƒ˜áƒ")

        page = st.radio(
            "áƒáƒ˜áƒ áƒ©áƒ˜áƒ” áƒ’áƒ•áƒ”áƒ áƒ“áƒ˜:",
            ["ğŸ“ áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ", "â• áƒáƒ®áƒáƒšáƒ˜ áƒáƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ", "ğŸ“Š áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ"],
            label_visibility="collapsed"
        )

        st.divider()

        # Quick stats
        st.subheader("ğŸ“Š áƒ¡áƒ¬áƒ áƒáƒ¤áƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ")
        all_drafts = db.get_all_drafts()
        draft_count = len([d for d in all_drafts if d['status'] == 'draft'])
        approved_count = len([d for d in all_drafts if d['status'] == 'approved'])

        st.metric("áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜", draft_count)
        st.metric("áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ£áƒšáƒ˜", approved_count)

    # Main content area
    if page == "ğŸ“ áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ":
        show_drafts_page(db)

    elif page == "â• áƒáƒ®áƒáƒšáƒ˜ áƒáƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ":
        show_create_page(db)

    elif page == "ğŸ“Š áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ":
        show_statistics_page(db)


def show_drafts_page(db: Database):
    """Show and edit drafts."""
    st.header("ğŸ“ áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜áƒ¡ áƒ›áƒáƒ áƒ—áƒ•áƒ")

    # Get draft ID from URL parameters (if sent from Telegram)
    query_params = st.query_params
    selected_draft_id = query_params.get("draft_id", None)

    if selected_draft_id:
        selected_draft_id = int(selected_draft_id)

    # Filter options
    col1, col2 = st.columns([3, 1])

    with col1:
        status_filter = st.selectbox(
            "áƒ¤áƒ˜áƒšáƒ¢áƒ áƒ˜ áƒ¡áƒ¢áƒáƒ¢áƒ£áƒ¡áƒ˜áƒ—:",
            ["áƒ§áƒ•áƒ”áƒšáƒ", "draft", "approved", "published", "rejected"]
        )

    with col2:
        sort_order = st.selectbox("áƒ“áƒáƒšáƒáƒ’áƒ”áƒ‘áƒ:", ["áƒáƒ®áƒáƒšáƒ˜ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜", "áƒ«áƒ•áƒ”áƒšáƒ˜ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜"])

    # Get drafts
    if status_filter == "áƒ§áƒ•áƒ”áƒšáƒ":
        drafts = db.get_all_drafts()
    else:
        drafts = db.get_all_drafts(status=status_filter)

    if sort_order == "áƒ«áƒ•áƒ”áƒšáƒ˜ áƒáƒ˜áƒ áƒ•áƒ”áƒšáƒ˜":
        drafts = list(reversed(drafts))

    if not drafts:
        st.info("ğŸ“­ áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡.")
        return

    # Display drafts
    for draft in drafts:
        # Highlight if this is the selected draft
        is_selected = (selected_draft_id == draft['id'])

        with st.expander(
            f"{'ğŸ”¹' if is_selected else 'ğŸ“„'} #{draft['id']} - {draft['honey_type']} ({draft['status']})",
            expanded=is_selected
        ):
            col1, col2 = st.columns([2, 1])

            with col1:
                # Editable text area
                new_text = st.text_area(
                    "áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜:",
                    value=draft['post_text'],
                    height=200,
                    key=f"text_{draft['id']}"
                )

                # Save button
                if st.button(f"ğŸ’¾ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ", key=f"save_{draft['id']}"):
                    if new_text != draft['post_text']:
                        db.update_draft_text(draft['id'], new_text, edited_by="user")
                        st.success("âœ“ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ!")
                        st.rerun()

                # Status update
                col_a, col_b, col_c = st.columns(3)

                with col_a:
                    if st.button("âœ… áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ", key=f"approve_{draft['id']}"):
                        db.update_draft_status(draft['id'], "approved")
                        st.success("áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ£áƒšáƒ˜áƒ!")
                        st.rerun()

                with col_b:
                    if st.button("âŒ áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ", key=f"reject_{draft['id']}"):
                        db.update_draft_status(draft['id'], "rejected")
                        st.warning("áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒšáƒ˜áƒ!")
                        st.rerun()

                with col_c:
                    if st.button("ğŸ—‘ï¸ áƒ¬áƒáƒ¨áƒšáƒ", key=f"delete_{draft['id']}"):
                        db.delete_draft(draft['id'])
                        st.success("áƒ¬áƒáƒ¨áƒšáƒ˜áƒšáƒ˜áƒ!")
                        st.rerun()

            with col2:
                # Display image if available
                if draft['image_path'] and os.path.exists(draft['image_path']):
                    try:
                        image = Image.open(draft['image_path'])
                        st.image(image, caption=f"#{draft['id']}", use_container_width=True)
                    except Exception as e:
                        st.error(f"áƒ¡áƒ£áƒ áƒáƒ—áƒ˜áƒ¡ áƒ©áƒáƒ¢áƒ•áƒ˜áƒ áƒ—áƒ•áƒ áƒ•áƒ”áƒ  áƒ›áƒáƒ®áƒ”áƒ áƒ®áƒ“áƒ: {e}")
                else:
                    st.info("ğŸ“· áƒ¡áƒ£áƒ áƒáƒ—áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡")

                # Metadata
                st.caption(f"**áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒšáƒ˜áƒ:** {draft['created_at'][:16]}")
                st.caption(f"**áƒ’áƒáƒœáƒáƒ®áƒšáƒ”áƒ‘áƒ£áƒšáƒ˜áƒ:** {draft['updated_at'][:16]}")

            # Show edit history
            if st.checkbox(f"ğŸ“œ áƒ áƒ”áƒ“áƒáƒ¥áƒ¢áƒ˜áƒ áƒ”áƒ‘áƒ˜áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ", key=f"history_{draft['id']}"):
                history = db.get_edit_history(draft['id'])

                if history:
                    for edit in history:
                        st.caption(
                            f"âœï¸ {edit['edited_at'][:16]} - {edit['edited_by']}"
                        )
                else:
                    st.caption("áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒªáƒáƒ áƒ˜áƒ”áƒšáƒ˜áƒ")


def show_create_page(db: Database):
    """Page for creating new posts manually."""
    st.header("â• áƒáƒ®áƒáƒšáƒ˜ áƒáƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ")

    st.info("ğŸ’¡ áƒáƒ®áƒáƒšáƒ˜ áƒáƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ¥áƒ›áƒœáƒ”áƒšáƒáƒ“ áƒ’áƒáƒ›áƒáƒ˜áƒ§áƒ”áƒœáƒ” Telegram Bot: /create [áƒ«áƒ›áƒ áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜]")

    st.divider()

    st.subheader("áƒ®áƒ”áƒšáƒ˜áƒ— áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ (áƒ›áƒáƒ¡áƒáƒ¬áƒ•áƒ“áƒáƒ“)")

    honey_type = st.text_input("áƒ«áƒ›áƒ áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ˜:", placeholder="áƒ›áƒáƒ’: áƒ‘áƒ áƒáƒ¬áƒ”áƒ£áƒšáƒ˜áƒ¡ áƒ«áƒ›áƒáƒ áƒ˜")

    post_text = st.text_area(
        "áƒáƒáƒ¡áƒ¢áƒ˜áƒ¡ áƒ¢áƒ”áƒ¥áƒ¡áƒ¢áƒ˜:",
        height=200,
        placeholder="áƒ“áƒáƒ¬áƒ”áƒ áƒ” áƒáƒáƒ¡áƒ¢áƒ˜ áƒáƒ¥..."
    )

    if st.button("ğŸ’¾ áƒ“áƒ áƒáƒ¤áƒ¢áƒ˜áƒ¡ áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ"):
        if honey_type and post_text:
            draft_id = db.create_draft(
                honey_type=honey_type,
                post_text=post_text,
                image_path=None
            )
            st.success(f"âœ“ áƒ“áƒ áƒáƒ¤áƒ¢áƒ˜ #{draft_id} áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒšáƒ˜áƒ!")
        else:
            st.error("âŒ áƒ’áƒ—áƒ®áƒáƒ•, áƒ¨áƒ”áƒáƒ•áƒ¡áƒ” áƒ§áƒ•áƒ”áƒšáƒ áƒ•áƒ”áƒšáƒ˜.")


def show_statistics_page(db: Database):
    """Show statistics and analytics."""
    st.header("ğŸ“Š áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ")

    all_drafts = db.get_all_drafts()

    if not all_drafts:
        st.info("ğŸ“­ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡.")
        return

    # Status distribution
    col1, col2, col3, col4 = st.columns(4)

    with col1:
        draft_count = len([d for d in all_drafts if d['status'] == 'draft'])
        st.metric("ğŸ“ áƒ“áƒ áƒáƒ¤áƒ¢áƒ”áƒ‘áƒ˜", draft_count)

    with col2:
        approved_count = len([d for d in all_drafts if d['status'] == 'approved'])
        st.metric("âœ… áƒ“áƒáƒ›áƒ¢áƒ™áƒ˜áƒªáƒ”áƒ‘áƒ£áƒšáƒ˜", approved_count)

    with col3:
        published_count = len([d for d in all_drafts if d['status'] == 'published'])
        st.metric("ğŸ‰ áƒ’áƒáƒ›áƒáƒ¥áƒ•áƒ”áƒ§áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜", published_count)

    with col4:
        rejected_count = len([d for d in all_drafts if d['status'] == 'rejected'])
        st.metric("âŒ áƒ£áƒáƒ áƒ§áƒáƒ¤áƒ˜áƒšáƒ˜", rejected_count)

    st.divider()

    # Recent activity
    st.subheader("ğŸ•’ áƒ‘áƒáƒšáƒ áƒáƒ¥áƒ¢áƒ˜áƒ•áƒáƒ‘áƒ")

    recent_drafts = all_drafts[:10]

    for draft in recent_drafts:
        status_emoji = {
            'draft': 'ğŸ“',
            'approved': 'âœ…',
            'published': 'ğŸ‰',
            'rejected': 'âŒ'
        }.get(draft['status'], 'â“')

        st.caption(
            f"{status_emoji} **#{draft['id']}** - {draft['honey_type']} "
            f"({draft['created_at'][:16]})"
        )

    st.divider()

    # Honey types summary
    st.subheader("ğŸ¯ áƒ«áƒ›áƒ áƒ˜áƒ¡ áƒ¢áƒ˜áƒáƒ”áƒ‘áƒ˜")

    honey_types = {}
    for draft in all_drafts:
        honey_type = draft['honey_type']
        honey_types[honey_type] = honey_types.get(honey_type, 0) + 1

    for honey_type, count in sorted(honey_types.items(), key=lambda x: x[1], reverse=True):
        st.caption(f"ğŸ¯ {honey_type}: **{count}** áƒáƒáƒ¡áƒ¢áƒ˜")


# Run the app
if __name__ == "__main__":
    main()
